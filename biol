package org.example;

import org.telegram.telegrambots.bots.TelegramLongPollingBot;
import org.telegram.telegrambots.meta.TelegramBotsApi;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.methods.send.SendPhoto;
import org.telegram.telegrambots.meta.api.objects.InputFile;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.InlineKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.ReplyKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.InlineKeyboardButton;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardRow;
import org.telegram.telegrambots.updatesreceivers.DefaultBotSession;

import java.util.*;

public class Main extends TelegramLongPollingBot {

    private static final String BOT_USERNAME = "@Vaqtnitejaymiz_bot";
    private static final String BOT_TOKEN = "8267407945:AAF0GAM6I-BcJjZWh8NQdpltGYsS7nuSfhU";
    private static final long ADMIN_ID = 7038296036L;

    // Loyiha misollari uchun rasmlar (URL manzillar)
    private static final Map<String, String> PROJECT_EXAMPLES = Map.of(
            "bot", "https://via.placeholder.com/400x300/3498db/ffffff?text=Telegram+Bot+Projects",
            "website", "https://via.placeholder.com/400x300/2ecc71/ffffff?text=Web+Site+Projects",
            "app", "https://via.placeholder.com/400x300/e74c3c/ffffff?text=Mobile+App+Projects"
    );

    private Map<Long, String> userState = new HashMap<>();
    private Map<Long, String> userType = new HashMap<>();
    private Map<Long, String> userInfo = new HashMap<>();
    private Map<Long, String> userBudget = new HashMap<>();
    private Map<Long, String> userName = new HashMap<>();
    private Map<Long, List<String>> orderHistory = new HashMap<>();

    @Override
    public String getBotUsername() { return BOT_USERNAME; }

    @Override
    public String getBotToken() { return BOT_TOKEN; }

    @Override
    public void onUpdateReceived(Update update) {
        try {
            if (update.hasCallbackQuery()) {
                handleCallbackQuery(update);
            } else if (update.hasMessage() && update.getMessage().hasText()) {
                handleMessage(update);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void handleMessage(Update update) {
        long chatId = update.getMessage().getChatId();
        String text = update.getMessage().getText();
        String firstName = update.getMessage().getFrom().getFirstName();

        // Foydalanuvchi nomini saqlash
        if (!userName.containsKey(chatId)) {
            userName.put(chatId, firstName);
        }

        switch (text) {
            case "/start":
                sendWelcome(chatId, firstName);
                sendMainMenu(chatId);
                userState.put(chatId, "MAIN_MENU");
                break;

            case "/help":
                sendHelp(chatId);
                break;

            case "/myorders":
                showOrderHistory(chatId);
                break;

            default:
                handleUserResponse(chatId, text);
        }
    }

    private void handleCallbackQuery(Update update) {
        long chatId = update.getCallbackQuery().getMessage().getChatId();
        String data = update.getCallbackQuery().getData();

        try {
            switch (data) {
                case "Bot kerak":
                case "Web sayt kerak":
                case "Play Market ilova kerak":
                    userType.put(chatId, data);
                    sendBudgetMenu(chatId, data);
                    userState.put(chatId, "WAIT_BUDGET");
                    break;

                case "Narxlar":
                    sendPrices(chatId);
                    break;

                case "Admin bilan bog'lanish":
                    sendAdminContact(chatId);
                    break;

                case "Bot haqida":
                    sendBotInfo(chatId);
                    break;

                case "Isbotlar":
                    sendExamples(chatId);
                    break;

                case "Mening buyurtmalarim":
                    showOrderHistory(chatId);
                    break;

                case "Qo'llanma":
                    sendTutorial(chatId);
                    break;

                // Budget buttons
                case "500,000 So'm":
                case "100$":
                case "200$":
                case "500$":
                case "300$":
                case "+500$":
                case "1000$":
                case "+1000$":
                    handleBudgetSelection(chatId, data);
                    break;

                default:
                    sendText(chatId, "Noto'g'ri tanlov! Iltimos, menyudan tanlang.");
            }

            // Callback queryga javob berish
            answerCallbackQuery(update.getCallbackQuery().getId());

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void handleBudgetSelection(long chatId, String budget) {
        userBudget.put(chatId, budget);
        sendText(chatId, "‚úÖ Byudjet tanlandi: " + budget +
                "\n\nüìù Iltimos, qisqacha loyiha nima qilishini tushuntirib bering:" +
                "\n(Masalan: 'Online do'kon uchun bot kerak', 'Restoran menyusi uchun ilova' yoki 'Korxona veb-sayti')");
        userState.put(chatId, "WAIT_INFO");
    }

    private void handleUserResponse(long chatId, String text) {
        String state = userState.getOrDefault(chatId, "");

        switch (state) {
            case "WAIT_BUDGET":
                userBudget.put(chatId, text);
                sendText(chatId, "üìù Iltimos, qisqacha loyiha nima qilishini tushuntirib bering:");
                userState.put(chatId, "WAIT_INFO");
                break;

            case "WAIT_INFO":
                userInfo.put(chatId, text);
                sendText(chatId, "üì± Iltimos, telefon raqamingizni kiriting:\n" +
                        "(Format: +998901234567 yoki 901234567)");
                userState.put(chatId, "WAIT_PHONE");
                break;

            case "WAIT_PHONE":
                if (isValidPhone(text)) {
                    completeOrder(chatId, text);
                } else {
                    sendText(chatId, "‚ùå Telefon raqam noto'g'ri formatda! Iltimos, qayta kiriting:\n" +
                            "Masalan: +998901234567 yoki 901234567");
                }
                break;

            default:
                // Agar foydalanuvchi oddiy matn yuborsa, asosiy menyuni ko'rsat
                sendText(chatId, "Men sizga yordam bera olaman. Iltimos, menyudan biror narsani tanlang yoki /start buyrug'ini yuboring.");
        }
    }

    private boolean isValidPhone(String phone) {
        // Telefon raqamini tekshirish
        return phone.matches("(\\+998|998|8)?[0-9]{9}") || phone.matches("[0-9]{9}");
    }

    private void completeOrder(long chatId, String phone) {
        try {
            String type = userType.get(chatId);
            String budget = userBudget.get(chatId);
            String info = userInfo.get(chatId);
            String name = userName.getOrDefault(chatId, "Noma'lum");

            // Foydalanuvchiga xabar
            sendText(chatId, "‚úÖ **Buyurtma qabul qilindi!**\n\n" +
                    "Admingiz tez orada siz bilan bog'lanadi.\n" +
                    "üìû Telefon: " + phone + "\n" +
                    "üïê Bog'lanish vaqti: 24 soat ichida\n\n" +
                    "Yana biror xizmat kerak bo'lsa, /start buyrug'ini yuboring.");

            // Admin ga xabar
            String orderDetails = "üöÄ **YANGI BUYURTMA!**\n\n" +
                    "üë§ Ism: " + name + "\n" +
                    "üÜî Chat ID: " + chatId + "\n" +
                    "üì¶ Tur: " + type + "\n" +
                    "üí∞ Byudjet: " + budget + "\n" +
                    "üìã Tavsif: " + info + "\n" +
                    "üì± Telefon: " + phone + "\n" +
                    "‚è∞ Vaqt: " + new Date();

            sendText(ADMIN_ID, orderDetails);

            // Buyurtmalar tarixiga qo'shish
            orderHistory.computeIfAbsent(chatId, k -> new ArrayList<>())
                    .add(new Date() + " - " + type + " (" + budget + ")");

            // Holatlarni tozalash
            clearUserState(chatId);

        } catch (Exception e) {
            e.printStackTrace();
            sendText(chatId, "‚ùå Xatolik yuz berdi. Iltimos, qayta urinib ko'ring.");
        }
    }

    private void clearUserState(long chatId) {
        userState.remove(chatId);
        userType.remove(chatId);
        userBudget.remove(chatId);
        userInfo.remove(chatId);
    }

    private void sendWelcome(long chatId, String firstName) {
        String welcome = "üëã *Salom " + firstName + "!*\n\n" +
                "ü§ñ *Vaqt Tejam Bot* ga xush kelibsiz!\n" +
                "Men sizga dasturiy ta'minot xizmatlarini buyurtma qilishda yordam beraman.\n\n" +
                "‚ö°Ô∏è *Tez va sifatli xizmat*\n" +
                "üíº *Professional dasturchilar*\n" +
                "üí∞ *Hamarxorga mos narxlar*\n\n" +
                "Quyidagi menyudan kerakli xizmatni tanlang:";

        sendText(chatId, welcome);
    }

    private void sendMainMenu(long chatId) {
        SendMessage message = SendMessage.builder()
                .chatId(String.valueOf(chatId))
                .text("üè† **Asosiy Menyu**\nQuyidagi xizmatlardan birini tanlang:")
                .parseMode("Markdown")
                .replyMarkup(
                        InlineKeyboardMarkup.builder()
                                .keyboard(Arrays.asList(
                                        Arrays.asList(
                                                InlineKeyboardButton.builder().text("ü§ñ Bot kerak").callbackData("Bot kerak").build(),
                                                InlineKeyboardButton.builder().text("üåê Web sayt kerak").callbackData("Web sayt kerak").build(),
                                                InlineKeyboardButton.builder().text("üì± Ilova kerak").callbackData("Play Market ilova kerak").build()
                                        ),
                                        Arrays.asList(
                                                InlineKeyboardButton.builder().text("üí∞ Narxlar").callbackData("Narxlar").build(),
                                                InlineKeyboardButton.builder().text("üë®‚Äçüíº Admin").callbackData("Admin bilan bog'lanish").build()
                                        ),
                                        Arrays.asList(
                                                InlineKeyboardButton.builder().text("üìä Isbotlar").callbackData("Isbotlar").build(),
                                                InlineKeyboardButton.builder().text("‚ÑπÔ∏è Bot haqida").callbackData("Bot haqida").build()
                                        ),
                                        Arrays.asList(
                                                InlineKeyboardButton.builder().text("üìã Mening buyurtmalarim").callbackData("Mening buyurtmalarim").build(),
                                                InlineKeyboardButton.builder().text("‚ùì Qo'llanma").callbackData("Qo'llanma").build()
                                        )
                                ))
                                .build()
                )
                .build();
        executeMessage(message);
    }

    private void sendBudgetMenu(long chatId, String type) {
        String messageText = "";
        List<InlineKeyboardButton> row = new ArrayList<>();

        switch (type) {
            case "Bot kerak":
                messageText = "ü§ñ *Telegram Bot Narxlari*\n\nQuyidan byudjetingizni tanlang:";
                row.add(InlineKeyboardButton.builder().text("500,000 So'm").callbackData("500,000 So'm").build());
                row.add(InlineKeyboardButton.builder().text("100$").callbackData("100$").build());
                row.add(InlineKeyboardButton.builder().text("200$").callbackData("200$").build());
                row.add(InlineKeyboardButton.builder().text("500$").callbackData("500$").build());
                break;
            case "Web sayt kerak":
                messageText = "üåê *Web Sayt Narxlari*\n\nQuyidan byudjetingizni tanlang:";
                row.add(InlineKeyboardButton.builder().text("100$").callbackData("100$").build());
                row.add(InlineKeyboardButton.builder().text("300$").callbackData("300$").build());
                row.add(InlineKeyboardButton.builder().text("500$").callbackData("500$").build());
                row.add(InlineKeyboardButton.builder().text("+500$").callbackData("+500$").build());
                break;
            case "Play Market ilova kerak":
                messageText = "üì± *Mobil Ilova Narxlari*\n\nQuyidan byudjetingizni tanlang:";
                row.add(InlineKeyboardButton.builder().text("300$").callbackData("300$").build());
                row.add(InlineKeyboardButton.builder().text("500$").callbackData("500$").build());
                row.add(InlineKeyboardButton.builder().text("1000$").callbackData("1000$").build());
                row.add(InlineKeyboardButton.builder().text("+1000$").callbackData("+1000$").build());
                break;
        }

        SendMessage message = SendMessage.builder()
                .chatId(String.valueOf(chatId))
                .text(messageText)
                .parseMode("Markdown")
                .replyMarkup(
                        InlineKeyboardMarkup.builder()
                                .keyboard(Collections.singletonList(row))
                                .build()
                )
                .build();
        executeMessage(message);
    }

    private void sendPrices(long chatId) {
        String text = "‚≠êÔ∏è *DASTURIY TA'MINOT NARXLARI*\n\n" +
                "ü§ñ *Telegram Bot Yaratish*\n" +
                "‚Ä¢ Boshlang'ich narx: $100\n" +
                "‚Ä¢ Server: oyiga $7 (minimum 6 oy)\n" +
                "‚Ä¢ Muhim xususiyat: avtomatik javoblar, ma'lumotlar bazasi, to'lov tizimi\n\n" +
                "üåê *Veb-sayt Ishlab Chiqish*\n" +
                "‚Ä¢ Boshlang'ich narx: $500\n" +
                "‚Ä¢ Server: oyiga $10 (minimum 6 oy)\n" +
                "‚Ä¢ Muhim xususiyat: mobil moslashuvchan, admin panel, SEO optimallashtirish\n\n" +
                "üì± *Mobil Ilova (Android/iOS)*\n" +
                "‚Ä¢ Boshlang'ich narx: $1100\n" +
                "‚Ä¢ Server: oyiga $28 (minimum 6 oy)\n" +
                "‚Ä¢ Muhim xususiyat: oflayn ishlash, push-xabarlar, ichki to'lov\n\n" +
                "üí° *Qo'shimcha ma'lumot:*\n" +
                "‚Ä¢ Narxlar loyiha murakkabligiga qarab o'zgarishi mumkin\n" +
                "‚Ä¢ Bepul konsultatsiya mavjud\n" +
                "‚Ä¢ Loyiha vaqti 2-8 hafta oralig'ida\n\n" +
                "üìû *Batafsil ma'lumot:* @It_project_2026 yoki +998900512621";

        sendText(chatId, text);
    }

    private void sendAdminContact(long chatId) {
        SendMessage message = SendMessage.builder()
                .chatId(String.valueOf(chatId))
                .text("üë®‚Äçüíº *Admin bilan bog'lanish*\n\n" +
                        "üì± *Telegram:* @It_project_2026\n" +
                        "üìû *Telefon:* +998900512621\n" +
                        "üïê *Ish vaqti:* 9:00 - 21:00\n\n" +
                        "‚úâÔ∏è *Email:* itprojects2026@gmail.com\n\n" +
                        "Shaxsiy masalalar uchun to'g'ridan-to'g'ri admin bilan bog'lanishingiz mumkin.")
                .parseMode("Markdown")
                .build();
        executeMessage(message);
    }

    private void sendBotInfo(long chatId) {
        String info = "ü§ñ *Vaqt Tejam Bot Haqida*\n\n" +
                "‚Ä¢ *Yaratilgan sana:* 2024-yil\n" +
                "‚Ä¢ *Versiya:* 2.0\n" +
                "‚Ä¢ *Maqsad:* Dasturiy ta'minot xizmatlarini oson buyurtma qilish\n\n" +
                "‚öôÔ∏è *Xususiyatlar:*\n" +
                "‚úÖ Tez buyurtma berish\n" +
                "‚úÖ Narxlarni solishtirish\n" +
                "‚úÖ Admin bilan bevosita aloqa\n" +
                "‚úÖ Buyurtmalar tarixi\n" +
                "‚úÖ Loyiha misollarini ko'rish\n\n" +
                "üë®‚Äçüíª *Dasturchi:* Professional IT komanda\n\n" +
                "üìç *Xizmat ko'rsatish doirasi:* Butun O'zbekiston";

        sendText(chatId, info);
    }

    private void sendExamples(long chatId) {
        sendText(chatId, "üìä *Bajargan Loyihalarimizdan Namunalar*\n\n" +
                "ü§ñ *Telegram Botlar:*\n" +
                "‚Ä¢ E-dokon botlari\n" +
                "‚Ä¢ Maktab/qoshxona botlari\n" +
                "‚Ä¢ Kuryer xizmati botlari\n" +
                "‚Ä¢ To'lov tizimi botlari\n\n" +
                "üåê *Web Saytlar:*\n" +
                "‚Ä¢ Korxona veb-saytlari\n" +
                "‚Ä¢ Onlayn do'konlar\n" +
                "‚Ä¢ Landing pagelar\n" +
                "‚Ä¢ Portfolyo saytlari\n\n" +
                "üì± *Mobil Ilovalar:*\n" +
                "‚Ä¢ Turizm ilovalari\n" +
                "‚Ä¢ Ta'lim ilovalari\n" +
                "‚Ä¢ Biznes ilovalari\n" +
                "‚Ä¢ O'yinlar\n\n" +
                "üì∏ Loyiha rasmlarini ko'rish uchun @It_project_2026 ga murojaat qiling.");
    }

    private void sendTutorial(long chatId) {
        String tutorial = "üìñ *QO'LLANMA*\n\n" +
                "1Ô∏è‚É£ *Buyurtma berish:*\n" +
                "   - Xizmat turini tanlang\n" +
                "   - Byudjetni tanlang\n" +
                "   - Loyiha haqida ma'lumot bering\n" +
                "   - Telefon raqamingizni yuboring\n\n" +
                "2Ô∏è‚É£ *Narxlarni ko'rish:*\n" +
                "   - 'Narxlar' tugmasini bosing\n" +
                "   - Barcha xizmatlar narxlarini ko'ring\n\n" +
                "3Ô∏è‚É£ *Admin bilan aloqa:*\n" +
                "   - 'Admin' tugmasini bosing\n" +
                "   - Kontakt ma'lumotlarini oling\n\n" +
                "4Ô∏è‚É£ *Buyurtmalar tarixi:*\n" +
                "   - 'Mening buyurtmalarim' tugmasini bosing\n" +
                "   - Oldingi buyurtmalaringizni ko'ring\n\n" +
                "‚ùì *Savollar uchun:* @It_project_2026";

        sendText(chatId, tutorial);
    }

    private void showOrderHistory(long chatId) {
        List<String> orders = orderHistory.get(chatId);

        if (orders == null || orders.isEmpty()) {
            sendText(chatId, "üì≠ *Sizda hali buyurtmalar mavjud emas.*\n" +
                    "Yangi buyurtma berish uchun asosiy menyudan xizmat tanlang.");
        } else {
            StringBuilder history = new StringBuilder("üìã *BUYURTMALAR TARIXI*\n\n");
            for (int i = 0; i < orders.size(); i++) {
                history.append(i + 1).append(". ").append(orders.get(i)).append("\n\n");
            }
            history.append("Jami: ").append(orders.size()).append(" ta buyurtma");

            sendText(chatId, history.toString());
        }
    }

    private void sendHelp(long chatId) {
        sendText(chatId, "üÜò *YORDAM*\n\n" +
                "‚Ä¢ /start - Botni ishga tushirish\n" +
                "‚Ä¢ /help - Yordam olish\n" +
                "‚Ä¢ /myorders - Buyurtmalar tarixi\n\n" +
                "üë®‚Äçüíª *Muammo bo'lsa:* @It_project_2026");
    }

    private void sendText(long chatId, String text) {
        SendMessage message = SendMessage.builder()
                .chatId(String.valueOf(chatId))
                .text(text)
                .parseMode("Markdown")
                .disableWebPagePreview(false)
                .build();
        executeMessage(message);
    }

    private void answerCallbackQuery(String callbackQueryId) {
        try {
            execute(org.telegram.telegrambots.meta.api.methods.AnswerCallbackQuery.builder()
                    .callbackQueryId(callbackQueryId)
                    .build());
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void executeMessage(SendMessage message) {
        try {
            execute(message);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static void main(String[] args) {
        try {
            TelegramBotsApi botsApi = new TelegramBotsApi(DefaultBotSession.class);
            botsApi.registerBot(new Main());
            System.out.println("‚úÖ Vaqt Tejam Bot ishga tushdi!");
            System.out.println("ü§ñ Username: " + BOT_USERNAME);
            System.out.println("üë®‚Äçüíª Admin ID: " + ADMIN_ID);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
